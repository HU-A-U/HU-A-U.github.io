<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Docker中运行mitiproxy+celery</title>
      <link href="/2019/05/24/Docker%E4%B8%AD%E8%BF%90%E8%A1%8Cmitiproxy-celery/"/>
      <url>/2019/05/24/Docker%E4%B8%AD%E8%BF%90%E8%A1%8Cmitiproxy-celery/</url>
      
        <content type="html"><![CDATA[<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>本文只是关于在docker中运行mitmproxy和celery的过程；</p><h4 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h4><p>使用mitmproxy做中间人代理获取网站的请求和响应，以及使用<br>celery对截取的请求进行过滤解析后存库(关于mitmproxy和celery请见前面两篇)</p><h4 id="使用docker的原因"><a href="#使用docker的原因" class="headerlink" title="使用docker的原因"></a>使用docker的原因</h4><p>1.最初的本地开发环境是Windows系统，由于celery的某些版本对Windows不支持，所以会出现不兼容的问题，最后找到celery==4.3.0rc1版本，同时安装mitmproxy和celery成功.<br>2.当我在服务器(ubuntu16.04)上使用虚拟环境安装环境依赖的时候，安装mitmproxy一直安装失败，好像是关于系统编译的一些报错，mitmproxy只支持python3.6以上版本，查询无果，最后放弃。</p><p>使用docker最主要的就是隔离性，轻量化，版本控制，可移植性</p><h4 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h4><p>mitmproxy==4.0.4</p><p>celery==4.3.0rc1</p><h3 id="编写dockerfile"><a href="#编写dockerfile" class="headerlink" title="编写dockerfile"></a>编写dockerfile</h3><p>分别打包两个镜像，一个镜像运行proxy容器，一个镜像运行celery的worker</p><blockquote><p>关于dockerfile的语法,参考<a href="https://www.cnblogs.com/lienhua34/p/5170335.html" target="_blank" rel="noopener">https://www.cnblogs.com/lienhua34/p/5170335.html</a></p></blockquote><h4 id="proxy镜像"><a href="#proxy镜像" class="headerlink" title="proxy镜像"></a>proxy镜像</h4><p>首先创建Dockerfile文件，没有后缀，注意文件名首字母D大写，因为踩过坑</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">FROM python:3.7 </span><br><span class="line">ADD requirements.txt /tmp/requirements.txt</span><br><span class="line">RUN pip install -r /tmp/requirements.txt</span><br><span class="line">RUN mkdir /code</span><br><span class="line">WORKDIR /code</span><br><span class="line">COPY . /code</span><br><span class="line">COPY docker-entrypoint.sh docker-entrypoint.sh</span><br><span class="line">RUN chmod +x docker-entrypoint.sh</span><br><span class="line">RUN apt-get install libfontconfig</span><br><span class="line"></span><br><span class="line">EXPOSE 8080</span><br><span class="line"></span><br><span class="line">CMD /code/docker-entrypoint.sh</span><br></pre></td></tr></table></figure><p>使用EXPOSE命令将容器的运行端口8080暴露出来<br>使用CMD命令运行docker-entrypoint.sh启动文件，内容如下:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/mitmdump -s /code/start_script.py</span><br></pre></td></tr></table></figure><p>创建镜像，我使用的是daocloud平台打包镜像，比较方便，关联GitHub仓库就可以直接打包，有新的提交就会自动重新打包一个版本<br><img src="/2019/05/24/Docker中运行mitiproxy-celery/images/daocloud_task.png" alt="执行日志"></p>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> docker </tag>
            
            <tag> celery </tag>
            
            <tag> mitmproxy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker学习之Dockerfile</title>
      <link href="/2019/05/24/Docker%E5%AD%A6%E4%B9%A0%E4%B9%8BDockerfile/"/>
      <url>/2019/05/24/Docker%E5%AD%A6%E4%B9%A0%E4%B9%8BDockerfile/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>工作中的环境参数(个人使用)</title>
      <link href="/2019/04/20/workfile/"/>
      <url>/2019/04/20/workfile/</url>
      
        <content type="html"><![CDATA[<p><strong><em>服务器</em></strong></p><hr><p>ssh <a href="mailto:python@192.168.1.150" target="_blank" rel="noopener">python@192.168.1.150</a> ,     JYcxys@3030</p><p>因为我们总账系统里只有财务报表的数据，所以目前先帮您填写财务报表的数据后申报，财务报表处理完了会弹出一个页面，可以进去申报剩下的内容</p><p><strong><em>mysql地址</em></strong></p><hr><p>192.168.1.170:3306  连接串：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"mysql+pymysql://cic_admin:TaBoq,,1234@192.168.1.170:3306/cicjust_splinter?charset=utf8&amp;autocommit=true"</span></span><br></pre></td></tr></table></figure><p>192.168.10.11:3306 连接串：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"mysql+pymysql://cic_admin:159357a@&#123;&#125;:&#123;&#125;/cic_splinter?charset=utf8&amp;autocommit=true"</span></span><br></pre></td></tr></table></figure><p>Mysql 远程连接</p><p>mysql -u 用户名 -p密码 -h IP地址 -P 端口号 -D 数据库名字 </p><hr><p><strong>celery配置</strong></p><hr><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">RABBITMQ_HOST = <span class="string">'192.168.1.152'</span></span><br><span class="line">RABBITMQ_PORT = <span class="number">5672</span></span><br><span class="line"></span><br><span class="line">RABBITMQ_USER = <span class="string">'rabbitmq'</span></span><br><span class="line">RABBITMQ_PWD = <span class="string">'JYcxys@3030'</span></span><br><span class="line"></span><br><span class="line">REDIS_HOST = <span class="string">"192.168.1.152"</span></span><br><span class="line">REDIS_PORT = <span class="number">16379</span></span><br><span class="line"></span><br><span class="line">CELERY_BROKER_URL = <span class="string">'amqp://&#123;0&#125;:&#123;1&#125;@&#123;2&#125;:&#123;3&#125;/myvhost'</span>\</span><br><span class="line">    .format(RABBITMQ_USER,RABBITMQ_PWD,RABBITMQ_HOST,RABBITMQ_PORT)</span><br><span class="line"></span><br><span class="line">CELERY_RESULT_BACKEND = <span class="string">'redis://&#123;0&#125;:&#123;1&#125;/15'</span>.format(REDIS_HOST,REDIS_PORT)</span><br></pre></td></tr></table></figure><p><strong><em>celery命令</em></strong></p><p>1.守护进程启动方式(start/stop/restart)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">celery multi start export_for_in -A celery_tasks.celery_app -l info --logfile=./celerylog.log</span><br></pre></td></tr></table></figure><p>2.开启flower后台监控</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">celery.exe flower --broker=amqp://guest:guest@localhost:5672/test</span><br><span class="line">celery.exe flower -broker=amqp://cic_admin:JYcxys@3030@192.168.1.152:5672/yct</span><br></pre></td></tr></table></figure><p><strong><em>rabbitmq的安装与配置</em></strong></p><p><em>Windows安装rabbitmq</em></p><p><strong><em>docker命令</em></strong></p><hr><ol><li><p>启动chrome镜像</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -d --name chrome_for_yzf -p 5902:5900 -p 4442:4444 selenium/standalone-chrome-debug</span><br></pre></td></tr></table></figure></li><li><p>下载镜像</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker pull selenium/standalone-chrome-debug</span><br></pre></td></tr></table></figure><p>说明：standalone-chrome-debug 镜像是带有vnc server </p></li><li><p>运行容器(–name后为容器的名称,-d 守护进程运行,-p 由容器露出的8080端口,映射到宿主机的8081端口)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name your_app_name -p 8081:8080 -d selenium/standalone-chrome-debug</span><br></pre></td></tr></table></figure></li></ol><ol start="4"><li><p>使用docker MySQL</p><ol><li><p>拉取mysql镜像 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull daocloud.io/library/mysql</span><br></pre></td></tr></table></figure></li><li><p>运行MySQL容器 dockers(MYSQL_ROOT_PASSWORD=后为数据库定义密码用户名为root)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name mysql_service -e MYSQL_ROOT_PASSWORD=your_pwd -d daocloud.io/library/mysql</span><br></pre></td></tr></table></figure></li><li><p>使用其他的docker容器连接docker的MySQL服务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name some_app --link your_mysql_name:mysql -p 8080:8080 -d daocloud.io/library/mysql</span><br></pre></td></tr></table></figure></li><li><p>将MySQL容器内的数据持久化到宿主机上</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name mysql --privileged=true -v /home/docker_mysql/data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=cicjust_proxy -d daocloud.io/library/mysql</span><br></pre></td></tr></table></figure></li></ol></li></ol>]]></content>
      
      
      <categories>
          
          <category> Diary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 杂记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ubuntu下安装python3</title>
      <link href="/2019/03/01/ubuntu%E4%B8%8Bpython3%E7%9A%84%E5%AE%89%E8%A3%85/"/>
      <url>/2019/03/01/ubuntu%E4%B8%8Bpython3%E7%9A%84%E5%AE%89%E8%A3%85/</url>
      
        <content type="html"><![CDATA[<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>ubuntu系统自带python2.7，不同的版本的ubuntu所带的python3的版本也有所不同，我现在使用的这台是python3.5;由于需要的服务只支持python3.6以上版本，所以本文以安装python3.7为例</p><h4 id="服务器运行环境："><a href="#服务器运行环境：" class="headerlink" title="服务器运行环境："></a>服务器运行环境：</h4><pre><code>ubuntu18.04</code></pre><h4 id="安装方式简介"><a href="#安装方式简介" class="headerlink" title="安装方式简介:"></a>安装方式简介:</h4><pre><code>不影响已有的python其他版本环境增量式安装完全隔离的沙箱环境</code></pre><h3 id="基本环境-便于后面的编译成功"><a href="#基本环境-便于后面的编译成功" class="headerlink" title="基本环境(便于后面的编译成功)"></a>基本环境(便于后面的编译成功)</h3><p>中间可能有多余空格，去除下再运行，一般都能安装成功，如果不能可以先更新下sudo apt-get update</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install zlib1g-dev libbz2-dev libssl-dev libncurses5-dev libsqlite3-dev </span><br><span class="line">libreadline-dev tk-dev libgdbm-dev libdb-dev libpcap-dev xz-utils libexpat1-dev </span><br><span class="line">liblzma-dev libffi-dev libc6-dev</span><br></pre></td></tr></table></figure><h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p>在python官网下载指定平台下的python3.7.1的环境</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://www.python.org/ftp/python/3.7.1/Python-3.7.1.tgz</span><br></pre></td></tr></table></figure><p>下载完成后，所在目录下会有 Python-3.7.1.tgz 的文件</p><h3 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h3><p>进行解压</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -xvzf Python-3.7.1.tgz</span><br></pre></td></tr></table></figure><p>所在目录下会有 Python-3.7.1 的文件夹</p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>进入文件夹Python-3.7.1,进行配置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd Python-3.7.1</span><br><span class="line">./configure --with-ssl --prefix=/usr/local/python3</span><br></pre></td></tr></table></figure><p>编译、安装</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure><blockquote><p>执行后可能会报错，请参考<a href="https://blog.csdn.net/jpch89/article/details/81813267" target="_blank" rel="noopener">https://blog.csdn.net/jpch89/article/details/81813267</a></p></blockquote><h3 id="删除软链"><a href="#删除软链" class="headerlink" title="删除软链"></a>删除软链</h3><p>先执行查看版本，如果有则证明软连接已经存在，先将其删除再重新建立</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># python3 -V</span><br><span class="line">Python 3.5.2</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># pip3 -V</span><br><span class="line">The program &apos;pip3&apos; is currently not installed. You can install it by typing:apt install python3-pip</span><br></pre></td></tr></table></figure><p>可见我的机器上的默认的python3的版本为3.5，pip3没有安装</p><p>删除软链</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># rm -rf /usr/bin/python3</span><br><span class="line"># rm -rf /usr/bin/pip3</span><br></pre></td></tr></table></figure><h3 id="建立新的指向python3-7的软链"><a href="#建立新的指向python3-7的软链" class="headerlink" title="建立新的指向python3.7的软链"></a>建立新的指向python3.7的软链</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#添加python3的软链接</span><br><span class="line">ln -s /usr/local/python3/bin/python3.7 /usr/bin/python3</span><br><span class="line">#添加 pip3 的软链接</span><br><span class="line">ln -s /usr/local/python3/bin/pip3.7 /usr/bin/pip3</span><br></pre></td></tr></table></figure><h3 id="查看版本"><a href="#查看版本" class="headerlink" title="查看版本"></a>查看版本</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># python3 -V</span><br><span class="line">Python 3.7.1</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># pip3 -V</span><br><span class="line">pip 10.0.1 from /usr/local/python3/lib/python3.7/site-packages/pip (python 3.7)</span><br></pre></td></tr></table></figure><p>至此安装成功。</p>]]></content>
      
      
      <categories>
          
          <category> Diary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>小记--阿里云环境配置</title>
      <link href="/2019/03/01/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E9%97%AE%E9%A2%98/"/>
      <url>/2019/03/01/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<p>今天在阿里云上使用pip3安装虚拟环境的时候，出现了一个错误locale.Error: unsupported locale setting</p><p>不支持语言环境，报错如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@iZuf6eh47kp5ew16h2mywqZ:~# sudo pip3 install virtualenv</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;/usr/bin/pip3&quot;, line 11, in &lt;module&gt;</span><br><span class="line">    sys.exit(main())</span><br><span class="line">  File &quot;/usr/lib/python3/dist-packages/pip/__init__.py&quot;, line 215, in main</span><br><span class="line">    locale.setlocale(locale.LC_ALL, &apos;&apos;)</span><br><span class="line">  File &quot;/usr/lib/python3.5/locale.py&quot;, line 594, in setlocale</span><br><span class="line">    return _setlocale(category, locale)</span><br><span class="line">locale.Error: unsupported locale setting</span><br></pre></td></tr></table></figure><p>解决办法很简单，设置语言就好了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export LC_ALL=&quot;en_US.UTF-8&quot;</span><br><span class="line">export LC_CTYPE=&quot;en_US.UTF-8&quot;</span><br></pre></td></tr></table></figure><p>执行上面这两句就OK了，后面就可以继续pip安装了。</p>]]></content>
      
      
      <categories>
          
          <category> Diary </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> pip </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
